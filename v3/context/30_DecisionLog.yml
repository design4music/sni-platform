decisions:

  - id: D-001
    date: 2025-11-01
    type: architectural
    status: accepted
    title: Replace Neo4j graph clustering with centroid-based architecture
    rationale:
      - Graph clustering was expensive and opaque
      - PostgreSQL-only architecture reduces complexity
      - Centroids provide explicit, auditable narrative anchors
    consequences:
      - No emergent topic discovery
      - Manual centroid curation required
    references:
      - V3_PIPELINE_STATUS.md

  - id: D-002
    date: 2025-11-03
    type: data-model
    status: accepted
    title: Adopt CTM (Centroid–Track–Month) as atomic intelligence unit
    rationale:
      - Aligns aggregation with strategic time horizons
      - Prevents narrative drift across months
      - Simplifies frontend consumption
    consequences:
      - Titles are demoted to inputs
      - CTMs become primary analysis objects

  - id: D-003
    date: 2025-11-05
    type: llm-usage
    status: accepted
    title: Restrict LLMs to judgment-only tasks
    rationale:
      - LLMs are unreliable for structural grouping
      - Determinism required for clustering
    scope:
      - Track assignment
      - Event extraction
      - Narrative summarization

  - id: D-004
    date: 2025-11-06
    type: quality-control
    status: accepted
    title: Introduce stop-word and language false-positive filtering
    rationale:
      - Prevent cultural/sport contamination
      - Eliminate Romance-language alias collisions
    impact:
      - Reduced false positives
      - Cleaner systemic centroids

  - id: D-005
    date: 2025-11-07
    type: extensibility
    status: accepted
    title: Implement dynamic track configuration system
    rationale:
      - One-size-fits-all tracks reduce precision
      - Domains require domain-specific track vocabularies
    consequences:
      - Track logic moves to database
      - No redeploy required for track edits

  - id: D-006
    date: 2026-01-02
    type: architectural
    status: accepted
    title: Switch from sequential 3-pass early-exit to accumulative centroid matching
    rationale:
      - Sequential passes missed bilateral relationships (Denmark+Trump matched only Denmark)
      - Early-exit prevented multi-centroid assignment needed for relationship tracking
      - Accumulative matching enables comprehensive event aggregation per centroid
      - Supports bilateral relationship queries (all US-Russia interaction events)
    consequences:
      - Higher centroid assignments per title (44% multi-centroid vs ~5% before)
      - Increased CTM volume (more centroids per title → more CTMs)
      - Pass concept obsolete (all patterns checked regardless of centroid class)
      - Removed is_macro field from centroids_v3 schema
    implementation:
      - Hash-based single-word matching (O(1) lookup, 3600+ aliases)
      - Precompiled regex patterns (1700+ patterns compiled once)
      - Script-aware matching (word boundaries for ASCII, substring for CJK/Arabic)
      - Batched database updates for 2K+ titles/day scale
      - Hyphenated compound splitting (China-made matches China)
      - Diacritic normalization (Côte d'Ivoire matches Cote d'Ivoire)
    performance:
      - Coverage increased from ~45% to 66.5% on test dataset (872 titles)
      - Multi-centroid rate: 44% (259/580 matched titles)
      - Centroid coverage: 77.6% (66/85 centroids matched)
    references:
      - Phase 2 implementation: v3/phase_2/match_centroids.py
      - Taxonomy migration: db/migrate_taxonomy_simplify_schema.py
      - Schema migration: db/migrate_drop_is_macro.py

  - id: D-007
    date: 2026-01-09
    type: llm-usage
    status: accepted
    title: Implement dynamic focus lines for Phase 4.2 summary generation
    rationale:
      - Prevent forced narrative coherence across thematically unrelated events
      - Enable centroid-specific and track-specific guidance for LLM
      - Address temporal drift (LLM inferring roles/titles from training data)
    implementation:
      - track_configs.llm_summary_centroid_focus (TEXT) - structural focus per centroid type
      - track_configs.llm_summary_track_focus (JSONB) - domain focus per track (GEO only)
      - Prompt allows 2-4 paragraphs based on natural thematic grouping
      - Anti-coherence instruction: "Do NOT force unrelated events into false narrative"
      - Temporal grounding: "Do NOT infer current offices or roles unless explicitly stated"
    consequences:
      - More accurate multi-event summaries (e.g., USA humanitarian CTM with Venezuela + domestic)
      - Reduced hallucination of current political roles
      - Better thematic separation in complex CTMs
    references:
      - v3/phase_4/generate_summaries.py
      - v3/phase_4/test_summary_single_ctm.py
      - db/migrations/20260109_add_summary_focus_lines.sql

  - id: D-008
    date: 2026-01-12
    type: operational
    status: accepted
    title: Complete Phase 4 daemon integration with monitoring
    rationale:
      - Phase 4 needed production orchestration alongside Phases 1-3
      - Summary length creep is a real concern as titles accumulate daily
      - Need observability for accumulation behavior before over-engineering CTW
    implementation:
      - Integrated Phase 4.1 (events) and 4.2 (summaries) into daemon
      - Added word count monitoring after each Phase 4.2 run
      - 1-hour interval for Phase 4 (less frequent than matching/assignment)
      - 50 CTM batch size for enrichment
      - Fixed SQL bug in assign_tracks.py (line 290: check title_assignments table)
    testing_plan:
      - Run daemon for 3-5 consecutive days
      - Monitor summary word counts (target: 150-250 words)
      - Track which CTMs grow fastest
      - Determine if current architecture handles accumulation or if CTW needed
    consequences:
      - Full 4-phase pipeline operational in production mode
      - Data-driven decision on CTM vs CTW architecture
      - Word count monitoring detects length bloat early
    references:
      - v3/runner/pipeline_daemon.py
      - v3/runner/README.md
