decisions:

  - id: D-001
    date: 2025-11-01
    type: architectural
    status: accepted
    title: Replace Neo4j graph clustering with centroid-based architecture
    rationale:
      - Graph clustering was expensive and opaque
      - PostgreSQL-only architecture reduces complexity
      - Centroids provide explicit, auditable narrative anchors
    consequences:
      - No emergent topic discovery
      - Manual centroid curation required
    references:
      - V3_PIPELINE_STATUS.md

  - id: D-002
    date: 2025-11-03
    type: data-model
    status: accepted
    title: Adopt CTM (Centroid–Track–Month) as atomic intelligence unit
    rationale:
      - Aligns aggregation with strategic time horizons
      - Prevents narrative drift across months
      - Simplifies frontend consumption
    consequences:
      - Titles are demoted to inputs
      - CTMs become primary analysis objects

  - id: D-003
    date: 2025-11-05
    type: llm-usage
    status: accepted
    title: Restrict LLMs to judgment-only tasks
    rationale:
      - LLMs are unreliable for structural grouping
      - Determinism required for clustering
    scope:
      - Track assignment
      - Event extraction
      - Narrative summarization

  - id: D-004
    date: 2025-11-06
    type: quality-control
    status: accepted
    title: Introduce stop-word and language false-positive filtering
    rationale:
      - Prevent cultural/sport contamination
      - Eliminate Romance-language alias collisions
    impact:
      - Reduced false positives
      - Cleaner systemic centroids

  - id: D-005
    date: 2025-11-07
    type: extensibility
    status: accepted
    title: Implement dynamic track configuration system
    rationale:
      - One-size-fits-all tracks reduce precision
      - Domains require domain-specific track vocabularies
    consequences:
      - Track logic moves to database
      - No redeploy required for track edits

  - id: D-006
    date: 2026-01-02
    type: architectural
    status: accepted
    title: Switch from sequential 3-pass early-exit to accumulative centroid matching
    rationale:
      - Sequential passes missed bilateral relationships (Denmark+Trump matched only Denmark)
      - Early-exit prevented multi-centroid assignment needed for relationship tracking
      - Accumulative matching enables comprehensive event aggregation per centroid
      - Supports bilateral relationship queries (all US-Russia interaction events)
    consequences:
      - Higher centroid assignments per title (44% multi-centroid vs ~5% before)
      - Increased CTM volume (more centroids per title → more CTMs)
      - Pass concept obsolete (all patterns checked regardless of centroid class)
      - Removed is_macro field from centroids_v3 schema
    implementation:
      - Hash-based single-word matching (O(1) lookup, 3600+ aliases)
      - Precompiled regex patterns (1700+ patterns compiled once)
      - Script-aware matching (word boundaries for ASCII, substring for CJK/Arabic)
      - Batched database updates for 2K+ titles/day scale
      - Hyphenated compound splitting (China-made matches China)
      - Diacritic normalization (Côte d'Ivoire matches Cote d'Ivoire)
    performance:
      - Coverage increased from ~45% to 66.5% on test dataset (872 titles)
      - Multi-centroid rate: 44% (259/580 matched titles)
      - Centroid coverage: 77.6% (66/85 centroids matched)
    references:
      - Phase 2 implementation: v3/phase_2/match_centroids.py
      - Taxonomy migration: db/migrate_taxonomy_simplify_schema.py
      - Schema migration: db/migrate_drop_is_macro.py

  - id: D-007
    date: 2026-01-09
    type: llm-usage
    status: accepted
    title: Implement dynamic focus lines for Phase 4.2 summary generation
    rationale:
      - Prevent forced narrative coherence across thematically unrelated events
      - Enable centroid-specific and track-specific guidance for LLM
      - Address temporal drift (LLM inferring roles/titles from training data)
    implementation:
      - track_configs.llm_summary_centroid_focus (TEXT) - structural focus per centroid type
      - track_configs.llm_summary_track_focus (JSONB) - domain focus per track (GEO only)
      - Prompt allows 2-4 paragraphs based on natural thematic grouping
      - Anti-coherence instruction: "Do NOT force unrelated events into false narrative"
      - Temporal grounding: "Do NOT infer current offices or roles unless explicitly stated"
    consequences:
      - More accurate multi-event summaries (e.g., USA humanitarian CTM with Venezuela + domestic)
      - Reduced hallucination of current political roles
      - Better thematic separation in complex CTMs
    references:
      - v3/phase_4/generate_summaries.py
      - v3/phase_4/test_summary_single_ctm.py
      - db/migrations/20260109_add_summary_focus_lines.sql

  - id: D-008
    date: 2026-01-12
    type: operational
    status: accepted
    title: Complete Phase 4 daemon integration with monitoring
    rationale:
      - Phase 4 needed production orchestration alongside Phases 1-3
      - Summary length creep is a real concern as titles accumulate daily
      - Need observability for accumulation behavior before over-engineering CTW
    implementation:
      - Integrated Phase 4.1 (events) and 4.2 (summaries) into daemon
      - Added word count monitoring after each Phase 4.2 run
      - 1-hour interval for Phase 4 (less frequent than matching/assignment)
      - 50 CTM batch size for enrichment
      - Fixed SQL bug in assign_tracks.py (line 290: check title_assignments table)
    testing_plan:
      - Run daemon for 3-5 consecutive days
      - Monitor summary word counts (target: 150-250 words)
      - Track which CTMs grow fastest
      - Determine if current architecture handles accumulation or if CTW needed
    consequences:
      - Full 4-phase pipeline operational in production mode
      - Data-driven decision on CTM vs CTW architecture
      - Word count monitoring detects length bloat early
    references:
      - v3/runner/pipeline_daemon.py
      - v3/runner/README.md

  - id: D-009
    date: 2026-01-16
    type: documentation
    status: accepted
    title: Consolidate frontend documentation into CoC and Status
    rationale: >
      Frontend is a non-intelligent consumer layer. Separate frontend docs
      caused duplication and drift. All frontend knowledge now lives in
      PIPELINE_STATUS.md as descriptive state.
    status: accepted

  - id: D-010
    date: 2025-10-28
    type: architecture
    status: accepted
    title: Replace Neo4j graph clustering with centroid-based PostgreSQL architecture
    rationale: >
      The previous v2 implementation relied on Neo4j graph clustering with PageRank,
      which introduced operational complexity, cost, and opaque behavior.
      The v3 design replaces this with explicit centroid-based matching implemented
      directly in PostgreSQL. This simplifies the architecture, improves performance,
      increases debuggability, and removes the dependency on graph infrastructure,
      while preserving strategic coverage and auditability.

  - id: D-011
    date: 2026-01-07
    type: data_model
    status: accepted
    title: Adopt many-to-many title–centroid–track relationships
    rationale: >
      Earlier designs forced a single track assignment per title, which caused
      logical inconsistencies when the same title was relevant to multiple centroids.
      The system now models title–centroid–track relationships explicitly, allowing
      each title to be analyzed independently in each strategic context.
      This preserves real-world complexity and prevents information loss.

  - id: D-012
    date: 2025-11-02
    type: filtering
    status: accepted
    title: Apply stop-word filtering only to systemic centroid matching
    rationale: >
      Strategic clusters were contaminated by culture and sports terms when applying
      systemic matching. A stop-word list is now applied exclusively to the systemic
      pass, while theater and macro matching remain unrestricted.
      This balances recall and precision by protecting high-level geographic anchors
      while tightening mid-level thematic centroids.

  - id: D-013
    date: 2025-11-06
    type: filtering
    status: accepted
    title: Mitigate Romance-language false positives in centroid matching
    rationale: >
      Romance-language articles produced false positives due to common articles
      (e.g., “il”, “la”) matching centroid aliases. The solution combined multiple
      measures: filtering Romance articles, removing uncommon ISO codes, and deleting
      ambiguous aliases (e.g., “IL” for Israel). This eliminated recurrent false
      assignments without harming recall.

  - id: D-014
    date: 2025-11-04
    type: taxonomy
    status: accepted
    title: Simplify taxonomy by removing redundant aliases
    rationale: >
      The taxonomy accumulated excessive redundancy across languages and formal names,
      increasing maintenance burden and false positives. A systematic pruning removed
      3,266 redundant aliases (22.3%) while retaining non-Latin scripts essential for
      global coverage. This improved performance, clarity, and maintainability.

  - id: D-015
    date: 2025-11-07
    type: classification
    status: accepted
    title: Introduce dynamic, centroid-specific track configurations
    rationale: >
      A single universal track list forced heterogeneous content into overly generic
      classifications. The system now supports centroid-specific track configurations
      stored in the database, allowing tech, climate, and quiet geographic centroids
      to use tailored track sets. This improves classification accuracy, reduces
      fragmentation, and enables domain expertise without code redeployment.

  - id: D-016
    date: 2026-01-07
    type: filtering
    status: accepted
    title: Add LLM-based strategic gating before track assignment
    rationale: >
      Mechanical filtering alone allowed some non-strategic content to pass into
      Phase 3. A two-stage LLM process was introduced: first, a strategic relevance
      gate (accept/reject), followed by track assignment for accepted titles.
      Rejected titles are explicitly marked to preserve auditability.

  - id: D-017
    date: 2025-11-07
    type: orchestration
    status: accepted
    title: Use sequential pipeline execution with adaptive scheduling
    rationale: >
      Although parallel execution is possible, the pipeline currently runs sequentially
      with phase-specific intervals. This design matches the actual bottlenecks
      (I/O-bound ingestion, fast mechanical matching, LLM-limited phases) and favors
      simplicity, observability, and debuggability. Parallelization is deferred until
      empirically required.

  - id: D-018
    date: 2026-01-18
    type: data_model
    status: accepted
    title: Normalize events into dedicated tables (events_v3)
    rationale: >
      Events were stored as JSONB arrays inside CTM rows (events_digest), making
      per-event updates impossible without rewriting the entire payload. Migrated to
      normalized events_v3 + event_v3_titles tables, enabling individual event summaries,
      incremental clustering, and independent lifecycle management. Each event now has
      its own row with title, summary, tags, source_batch_count, and bucket metadata.
    consequences:
      - Per-event LLM summary generation (Phase 4.5a) becomes possible
      - Incremental clustering can append titles to existing events
      - Frontend queries events directly instead of parsing JSONB
    references:
      - db/migrations/20260117_create_events_v3_tables.sql

  - id: D-019
    date: 2026-01-26
    type: architectural
    status: accepted
    title: Signal-based mechanical topic clustering (Phase 4)
    rationale: >
      Replaced LLM-based event extraction with deterministic clustering using typed
      signals (persons, orgs, places, commodities, policies, systems, named_events).
      Early titles define anchor signals that lock after 5 titles, preventing topic
      drift. Later titles match via weighted signal overlap. Geographic bucketing
      (domestic, bilateral-XX, other_international) structures events spatially.
      Sub-threshold titles route to catchall events per bucket.
    consequences:
      - Deterministic, reproducible clustering (no LLM variance)
      - LLM restricted to summary generation only (Phase 4.5a/4.5b)
      - Track-specific signal weights tune clustering per domain
      - Catchall events ensure 100% title coverage
    references:
      - pipeline/phase_4/incremental_clustering.py
      - core/config.py (TRACK_WEIGHTS, ANCHOR_LOCK_THRESHOLD, JOIN_THRESHOLD)

  - id: D-020
    date: 2026-01-30
    type: architectural
    status: accepted
    title: Restructure phases -- label extraction before intel gating
    rationale: >
      Previously, intel gating and track assignment ran before label extraction,
      meaning the LLM gating call had no entity/signal context. Reordering to
      3.1 (labels + signals) -> 3.2 (entity backfill) -> 3.3 (gating + tracks)
      gives Phase 3.3 richer context, enables mechanical pre-gating on safe label
      patterns (skipping LLM for obvious accepts), and reduces unnecessary API calls
      by ~30%.
    consequences:
      - Phase 3.3 can use label-based heuristics before calling LLM
      - Entity backfill adds centroid assignments before track routing
      - Pipeline phases renumbered from 3.5/3.6 to 3.1/3.2/3.3

  - id: D-021
    date: 2026-01-29
    type: operational
    status: accepted
    title: Monthly freeze process with centroid-level cross-track summaries
    rationale: >
      End-of-month boundary needed to prevent unbounded CTM growth and to produce
      archival-quality summaries. The freeze script marks all CTMs as frozen, generates
      a cross-track centroid summary via LLM (one paragraph per strategic track,
      200-300 words), and stores it in centroid_monthly_summaries. New titles after
      freeze go into fresh CTMs for the next month. Frontend switches to a different
      layout for frozen months (summary in main content, track nav in sticky sidebar).
    consequences:
      - Clean monthly boundaries for historical browsing
      - Centroid summaries provide executive-level cross-domain overview
      - Frozen CTMs and events are immutable (no re-clustering)
    references:
      - db/scripts/freeze_month.py
      - db/migrations/20260129_add_centroid_summaries_and_purge.sql

  - id: D-022
    date: 2026-02-01
    type: architectural
    status: accepted
    title: Non-destructive incremental clustering (Phase 4)
    rationale: >
      Phase 4 previously deleted all events for a CTM and rebuilt from scratch on
      every run, destroying LLM-generated summaries and event identity. Replaced with
      incremental approach: load only titles not yet linked to any event, match against
      existing events by signal overlap, create new events only for unmatched clusters.
      Existing event metadata (title, summary, tags) is never overwritten. Phase 4.5a
      uses summary_source_count to detect events that grew significantly and need
      re-summarization.
    consequences:
      - LLM summaries survive across pipeline runs
      - Event IDs are stable (can be bookmarked/referenced)
      - First run on empty CTM behaves identically to old cold path
      - events_v3.summary column changed to nullable
    references:
      - pipeline/phase_4/incremental_clustering.py (process_ctm_for_daemon)
      - db/migrations/20260201_add_summary_source_count.sql

  - id: D-023
    date: 2026-01-30
    type: operational
    status: accepted
    title: Local-dev / remote-demo deployment split
    rationale: >
      Running the pipeline on both local and remote would double LLM API costs and
      create data divergence. Local environment is the source of truth for development
      and data. Render.com hosts a read-only demo: Next.js frontend + managed PostgreSQL
      snapshot. Pipeline worker is suspended on Render. Database is synced via
      pg_dump/pg_restore from the local Docker PostgreSQL container when needed.
    consequences:
      - No live pipeline on remote (demo is a point-in-time snapshot)
      - Database updates require manual dump/restore cycle
      - Frontend code auto-deploys via Render on git push to main
    references:
      - render.yaml
      - pipeline/runner/sni-v3-pipeline.service (reference only, not active on Render)

