 SNI-v2\apps\ingest\rss_fetcher.py                                                                                                                                                                         │ │
│ │                                                                                                                                                                                                           │ │
│ │ """                                                                                                                                                                                                       │ │
│ │ RSS Feed Fetcher for SNI-v2                                                                                                                                                                               │ │
│ │ Fetches and normalizes headlines from RSS feeds                                                                                                                                                           │ │
│ │ """                                                                                                                                                                                                       │ │
│ │                                                                                                                                                                                                           │ │
│ │ import hashlib                                                                                                                                                                                            │ │
│ │ import re                                                                                                                                                                                                 │ │
│ │ from datetime import datetime, timezone                                                                                                                                                                   │ │
│ │ from typing import List, Dict, Optional, Tuple                                                                                                                                                            │ │
│ │ from urllib.parse import urlparse                                                                                                                                                                         │ │
│ │                                                                                                                                                                                                           │ │
│ │ import feedparser                                                                                                                                                                                         │ │
│ │ import requests                                                                                                                                                                                           │ │
│ │ from langdetect import detect, DetectorFactory                                                                                                                                                            │ │
│ │ from loguru import logger                                                                                                                                                                                 │ │
│ │ from unidecode import unidecode                                                                                                                                                                           │ │
│ │                                                                                                                                                                                                           │ │
│ │ from core.config import get_config                                                                                                                                                                        │ │
│ │ from core.database import get_db_session                                                                                                                                                                  │ │
│ │ from sqlalchemy import text                                                                                                                                                                               │ │
│ │                                                                                                                                                                                                           │ │
│ │ # Set seed for consistent language detection                                                                                                                                                              │ │
│ │ DetectorFactory.seed = 42                                                                                                                                                                                 │ │
│ │                                                                                                                                                                                                           │ │
│ │ class RSSFetcher:                                                                                                                                                                                         │ │
│ │     """RSS feed fetcher with normalization and deduplication"""                                                                                                                                           │ │
│ │                                                                                                                                                                                                           │ │
│ │     def __init__(self):                                                                                                                                                                                   │ │
│ │         self.config = get_config()                                                                                                                                                                        │ │
│ │         self.session = requests.Session()                                                                                                                                                                 │ │
│ │         self.session.headers.update({                                                                                                                                                                     │ │
│ │             'User-Agent': 'SNI-v2 RSS Fetcher/1.0 (Headlines Analysis)'                                                                                                                                   │ │
│ │         })                                                                                                                                                                                                │ │
│ │                                                                                                                                                                                                           │ │
│ │     def normalize_title(self, title: str, publisher_name: str = None) -> Tuple[str, str]:                                                                                                                 │ │
│ │         """                                                                                                                                                                                               │ │
│ │         Normalize title following Engineering Playbook D.5                                                                                                                                                │ │
│ │         Returns (display_title, normalized_title_for_matching)                                                                                                                                            │ │
│ │         """                                                                                                                                                                                               │ │
│ │         if not title:                                                                                                                                                                                     │ │
│ │             return "", ""                                                                                                                                                                                 │ │
│ │                                                                                                                                                                                                           │ │
│ │         # Unicode NFKC normalization                                                                                                                                                                      │ │
│ │         title = title.strip()                                                                                                                                                                             │ │
│ │                                                                                                                                                                                                           │ │
│ │         # Remove exact publisher suffix pattern                                                                                                                                                           │ │
│ │         if publisher_name:                                                                                                                                                                                │ │
│ │             suffix_pattern = f" – {re.escape(publisher_name)}"                                                                                                                                            │ │
│ │             if title.endswith(suffix_pattern):                                                                                                                                                            │ │
│ │                 title = title[:-len(suffix_pattern)]                                                                                                                                                      │ │
│ │                                                                                                                                                                                                           │ │
│ │         # Collapse internal whitespace                                                                                                                                                                    │ │
│ │         title_display = re.sub(r'\s+', ' ', title).strip()                                                                                                                                                │ │
│ │                                                                                                                                                                                                           │ │
│ │         # For matching: lowercase + remove non-informative symbols                                                                                                                                        │ │
│ │         title_norm = title_display.lower()                                                                                                                                                                │ │
│ │         # Remove common symbols but keep letters/numbers/basic punctuation                                                                                                                                │ │
│ │         title_norm = re.sub(r'[^\w\s\-.,!?:;]', '', title_norm)                                                                                                                                           │ │
│ │         title_norm = re.sub(r'\s+', ' ', title_norm).strip()                                                                                                                                              │ │
│ │                                                                                                                                                                                                           │ │
│ │         return title_display, title_norm                                                                                                                                                                  │ │
│ │                                                                                                                                                                                                           │ │
│ │     def detect_language(self, text: str) -> Tuple[Optional[str], float]:                                                                                                                                  │ │
│ │         """                                                                                                                                                                                               │ │
│ │         Detect language with confidence score                                                                                                                                                             │ │
│ │         Returns None if detection fails (graceful handling per D.5)                                                                                                                                       │ │
│ │         """                                                                                                                                                                                               │ │
│ │         try:                                                                                                                                                                                              │ │
│ │             if not text or len(text.strip()) < 3:                                                                                                                                                         │ │
│ │                 return None, 0.0                                                                                                                                                                          │ │
│ │                                                                                                                                                                                                           │ │
│ │             lang = detect(text)                                                                                                                                                                           │ │
│ │             # Simple confidence approximation based on text length                                                                                                                                        │ │
│ │             confidence = min(0.95, 0.3 + len(text) / 200)                                                                                                                                                 │ │
│ │             return lang, confidence                                                                                                                                                                       │ │
│ │                                                                                                                                                                                                           │ │
│ │         except Exception as e:                                                                                                                                                                            │ │
│ │             logger.debug(f"Language detection failed for text: {text[:50]}... - {e}")                                                                                                                     │ │
│ │             return None, 0.0                                                                                                                                                                              │ │
│ │                                                                                                                                                                                                           │ │
│ │     def extract_publisher_domain(self, url: str) -> Optional[str]:                                                                                                                                        │ │
│ │         """Extract clean domain from URL"""                                                                                                                                                               │ │
│ │         try:                                                                                                                                                                                              │ │
│ │             parsed = urlparse(url)                                                                                                                                                                        │ │
│ │             domain = parsed.netloc.lower()                                                                                                                                                                │ │
│ │             # Remove www prefix                                                                                                                                                                           │ │
│ │             if domain.startswith('www.'):                                                                                                                                                                 │ │
│ │                 domain = domain[4:]                                                                                                                                                                       │ │
│ │             return domain                                                                                                                                                                                 │ │
│ │         except:                                                                                                                                                                                           │ │
│ │             return None                                                                                                                                                                                   │ │
│ │                                                                                                                                                                                                           │ │
│ │     def generate_content_hash(self, title_norm: str, publisher_domain: str) -> str:                                                                                                                       │ │
│ │         """Generate content hash for deduplication"""                                                                                                                                                     │ │
│ │         content = f"{title_norm}||{publisher_domain or ''}"                                                                                                                                               │ │
│ │         return hashlib.sha256(content.encode('utf-8')).hexdigest()[:16]                                                                                                                                   │ │
│ │                                                                                                                                                                                                           │ │
│ │     def fetch_feed(self, feed_url: str, feed_id: str) -> List[Dict]:                                                                                                                                      │ │
│ │         """                                                                                                                                                                                               │ │
│ │         Fetch and parse RSS feed                                                                                                                                                                          │ │
│ │         Returns list of normalized articles                                                                                                                                                               │ │
│ │         """                                                                                                                                                                                               │ │
│ │         try:                                                                                                                                                                                              │ │
│ │             logger.info(f"Fetching RSS feed: {feed_url}")                                                                                                                                                 │ │
│ │                                                                                                                                                                                                           │ │
│ │             # Fetch with timeout and headers                                                                                                                                                              │ │
│ │             response = self.session.get(feed_url, timeout=30)                                                                                                                                             │ │
│ │             response.raise_for_status()                                                                                                                                                                   │ │
│ │                                                                                                                                                                                                           │ │
│ │             # Parse RSS                                                                                                                                                                                   │ │
│ │             feed = feedparser.parse(response.content)                                                                                                                                                     │ │
│ │                                                                                                                                                                                                           │ │
│ │             if feed.bozo and feed.bozo_exception:                                                                                                                                                         │ │
│ │                 logger.warning(f"Feed parsing warning for {feed_url}: {feed.bozo_exception}")                                                                                                             │ │
│ │                                                                                                                                                                                                           │ │
│ │             articles = []                                                                                                                                                                                 │ │
│ │                                                                                                                                                                                                           │ │
│ │             for entry in feed.entries[:50]:  # Limit to 50 most recent                                                                                                                                    │ │
│ │                 try:                                                                                                                                                                                      │ │
│ │                     # Extract basic fields                                                                                                                                                                │ │
│ │                     title_original = entry.get('title', '').strip()                                                                                                                                       │ │
│ │                     if not title_original:                                                                                                                                                                │ │
│ │                         continue                                                                                                                                                                          │ │
│ │                                                                                                                                                                                                           │ │
│ │                     # Get Google News URL (prefer link over id)                                                                                                                                           │ │
│ │                     url_gnews = entry.get('link', entry.get('id', ''))                                                                                                                                    │ │
│ │                     if not url_gnews:                                                                                                                                                                     │ │
│ │                         continue                                                                                                                                                                          │ │
│ │                                                                                                                                                                                                           │ │
│ │                     # Extract publication date                                                                                                                                                            │ │
│ │                     pubdate_utc = None                                                                                                                                                                    │ │
│ │                     if hasattr(entry, 'published_parsed') and entry.published_parsed:                                                                                                                     │ │
│ │                         pubdate_utc = datetime(*entry.published_parsed[:6], tzinfo=timezone.utc)                                                                                                          │ │
│ │                     elif hasattr(entry, 'updated_parsed') and entry.updated_parsed:                                                                                                                       │ │
│ │                         pubdate_utc = datetime(*entry.updated_parsed[:6], tzinfo=timezone.utc)                                                                                                            │ │
│ │                                                                                                                                                                                                           │ │
│ │                     # Get publisher info from feed                                                                                                                                                        │ │
│ │                     publisher_name = feed.feed.get('title', '').strip()                                                                                                                                   │ │
│ │                     publisher_domain = self.extract_publisher_domain(url_gnews)                                                                                                                           │ │
│ │                                                                                                                                                                                                           │ │
│ │                     # Normalize title                                                                                                                                                                     │ │
│ │                     title_display, title_norm = self.normalize_title(title_original, publisher_name)                                                                                                      │ │
│ │                                                                                                                                                                                                           │ │
│ │                     # Language detection                                                                                                                                                                  │ │
│ │                     detected_language, lang_confidence = self.detect_language(title_display)                                                                                                              │ │
│ │                                                                                                                                                                                                           │ │
│ │                     # Generate content hash for deduplication                                                                                                                                             │ │
│ │                     content_hash = self.generate_content_hash(title_norm, publisher_domain)                                                                                                               │ │
│ │                                                                                                                                                                                                           │ │
│ │                     article = {                                                                                                                                                                           │ │
│ │                         'feed_id': feed_id,                                                                                                                                                               │ │
│ │                         'title_original': title_original,                                                                                                                                                 │ │
│ │                         'title_display': title_display,                                                                                                                                                   │ │
│ │                         'title_norm': title_norm,                                                                                                                                                         │ │
│ │                         'url_gnews': url_gnews,                                                                                                                                                           │ │
│ │                         'publisher_name': publisher_name,                                                                                                                                                 │ │
│ │                         'publisher_domain': publisher_domain,                                                                                                                                             │ │
│ │                         'pubdate_utc': pubdate_utc,                                                                                                                                                       │ │
│ │                         'detected_language': detected_language,                                                                                                                                           │ │
│ │                         'language_confidence': lang_confidence,                                                                                                                                           │ │
│ │                         'content_hash': content_hash,                                                                                                                                                     │ │
│ │                         'ingested_at': datetime.now(timezone.utc)                                                                                                                                         │ │
│ │                     }                                                                                                                                                                                     │ │
│ │                                                                                                                                                                                                           │ │
│ │                     articles.append(article)                                                                                                                                                              │ │
│ │                                                                                                                                                                                                           │ │
│ │                 except Exception as e:                                                                                                                                                                    │ │
│ │                     logger.warning(f"Failed to process entry from {feed_url}: {e}")                                                                                                                       │ │
│ │                     continue                                                                                                                                                                              │ │
│ │                                                                                                                                                                                                           │ │
│ │             logger.info(f"Successfully processed {len(articles)} articles from {feed_url}")                                                                                                               │ │
│ │             return articles                                                                                                                                                                               │ │
│ │                                                                                                                                                                                                           │ │
│ │         except requests.RequestException as e:                                                                                                                                                            │ │
│ │             logger.error(f"HTTP error fetching {feed_url}: {e}")                                                                                                                                          │ │
│ │             return []                                                                                                                                                                                     │ │
│ │         except Exception as e:                                                                                                                                                                            │ │
│ │             logger.error(f"Error processing feed {feed_url}: {e}")                                                                                                                                        │ │
│ │             return []                                                                                                                                                                                     │ │
│ │                                                                                                                                                                                                           │ │
│ │     def insert_articles(self, articles: List[Dict]) -> Dict[str, int]:                                                                                                                                    │ │
│ │         """                                                                                                                                                                                               │ │
│ │         Insert articles into database with UPSERT for idempotency                                                                                                                                         │ │
│ │         Returns stats: inserted, updated, skipped                                                                                                                                                         │ │
│ │         """                                                                                                                                                                                               │ │
│ │         if not articles:                                                                                                                                                                                  │ │
│ │             return {'inserted': 0, 'updated': 0, 'skipped': 0}                                                                                                                                            │ │
│ │                                                                                                                                                                                                           │ │
│ │         stats = {'inserted': 0, 'updated': 0, 'skipped': 0}                                                                                                                                               │ │
│ │                                                                                                                                                                                                           │ │
│ │         try:                                                                                                                                                                                              │ │
│ │             with get_db_session() as session:                                                                                                                                                             │ │
│ │                 for article in articles:                                                                                                                                                                  │ │
│ │                     # Check if article exists by content_hash and feed_id                                                                                                                                 │ │
│ │                     existing = session.execute(                                                                                                                                                           │ │
│ │                         text("SELECT id FROM titles WHERE content_hash = :hash AND feed_id = :feed_id"),                                                                                                  │ │
│ │                         {"hash": article['content_hash'], "feed_id": article['feed_id']}                                                                                                                  │ │
│ │                     ).fetchone()                                                                                                                                                                          │ │
│ │                                                                                                                                                                                                           │ │
│ │                     if existing:                                                                                                                                                                          │ │
│ │                         stats['skipped'] += 1                                                                                                                                                             │ │
│ │                         continue                                                                                                                                                                          │ │
│ │                                                                                                                                                                                                           │ │
│ │                     # Insert new article                                                                                                                                                                  │ │
│ │                     insert_sql = text("""                                                                                                                                                                 │ │
│ │                         INSERT INTO titles (                                                                                                                                                              │ │
│ │                             feed_id, title_original, title_display, url_gnews,                                                                                                                            │ │
│ │                             publisher_name, publisher_domain, pubdate_utc,                                                                                                                                │ │
│ │                             detected_language, language_confidence, content_hash,                                                                                                                         │ │
│ │                             processing_status, ingested_at, created_at                                                                                                                                    │ │
│ │                         ) VALUES (                                                                                                                                                                        │ │
│ │                             :feed_id, :title_original, :title_display, :url_gnews,                                                                                                                        │ │
│ │                             :publisher_name, :publisher_domain, :pubdate_utc,                                                                                                                             │ │
│ │                             :detected_language, :language_confidence, :content_hash,                                                                                                                      │ │
│ │                             'pending', :ingested_at, :created_at                                                                                                                                          │ │
│ │                         )                                                                                                                                                                                 │ │
│ │                     """)                                                                                                                                                                                  │ │
│ │                                                                                                                                                                                                           │ │
│ │                     session.execute(insert_sql, {                                                                                                                                                         │ │
│ │                         'feed_id': article['feed_id'],                                                                                                                                                    │ │
│ │                         'title_original': article['title_original'],                                                                                                                                      │ │
│ │                         'title_display': article['title_display'],                                                                                                                                        │ │
│ │                         'url_gnews': article['url_gnews'],                                                                                                                                                │ │
│ │                         'publisher_name': article['publisher_name'],                                                                                                                                      │ │
│ │                         'publisher_domain': article['publisher_domain'],                                                                                                                                  │ │
│ │                         'pubdate_utc': article['pubdate_utc'],                                                                                                                                            │ │
│ │                         'detected_language': article['detected_language'],                                                                                                                                │ │
│ │                         'language_confidence': article['language_confidence'],                                                                                                                            │ │
│ │                         'content_hash': article['content_hash'],                                                                                                                                          │ │
│ │                         'ingested_at': article['ingested_at'],                                                                                                                                            │ │
│ │                         'created_at': article['ingested_at']                                                                                                                                              │ │
│ │                     })                                                                                                                                                                                    │ │
│ │                                                                                                                                                                                                           │ │
│ │                     stats['inserted'] += 1                                                                                                                                                                │ │
│ │                                                                                                                                                                                                           │ │
│ │         except Exception as e:                                                                                                                                                                            │ │
│ │             logger.error(f"Database error inserting articles: {e}")                                                                                                                                       │ │
│ │             raise                                                                                                                                                                                         │ │
│ │                                                                                                                                                                                                           │ │
│ │         logger.info(f"Article insertion complete: {stats}")                                                                                                                                               │ │
│ │         return stats                                                                                                                                                                                      │ │
│ 